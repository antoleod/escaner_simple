<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esc√°ner Web Pro</title>
  <style>
    :root {
      --bg:#0b1320; --fg:#eaeefb; --mut:#9fb0d0; --acc:#7aa2ff; --acc2:#00d4ff;
      --card:#0f1a33; --b:#ffffff14;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      background: radial-gradient(1200px 800px at 100% -10%, #13264e 0%, #0b1320 45%, #0b1320 100%);
      color:var(--fg);
      min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto;
    }
    header, footer{padding:12px 16px; background:linear-gradient(180deg, #0f1a33aa, #0f1a3300);
      border-bottom:1px solid var(--b); backdrop-filter: blur(6px);}
    footer{border-top:1px solid var(--b); border-bottom:none; color:var(--mut); font-size:12px;}
    h1{margin:0; font-size:20px; display:flex; align-items:center; gap:10px;}
    .pill{background:#0b172f; border:1px solid var(--b); padding:6px 10px; border-radius:999px; color:var(--mut); font-weight:700;}
    main{padding:12px; display:grid; gap:12px; max-width:1200px; width:100%; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--b); border-radius:16px; padding:12px; box-shadow: 0 10px 30px #00000055;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .grow{flex:1}
    video{width:100%; max-height:62dvh; display:block; background:#000; border-radius:16px; position:relative}
    .overlay{
      position:relative;
    }
    /* animated scan border */
    .overlay::before{
      content:""; position:absolute; inset:12px;
      border-radius:12px; border:2px dashed #75b4ff55;
      animation: glow 2.2s linear infinite;
      pointer-events:none;
    }
    @keyframes glow{
      0%{ box-shadow: 0 0 0px #7aa2ff44, inset 0 0 0px #7aa2ff44;}
      50%{ box-shadow: 0 0 18px #7aa2ff66, inset 0 0 18px #7aa2ff33;}
      100%{ box-shadow: 0 0 0px #7aa2ff44, inset 0 0 0px #7aa2ff44;}
    }
    /* moving scan line */
    .overlay::after{
      content:""; position:absolute; left:12px; right:12px; height:2px; top:18%;
      background: linear-gradient(90deg, transparent, var(--acc2), transparent);
      animation: scan 2s ease-in-out infinite;
      opacity:.7; border-radius:2px;
    }
    @keyframes scan{ 0%{ top:18% } 50%{ top:82% } 100%{ top:18% } }

    /* Buttons with subtle 3D / ripple */
    button, select, input[type="number"], input[type="text"], input[type="range"], input[type="file"]{
      border:1px solid var(--b); background:#0c1730; color:var(--fg);
      padding:10px 14px; border-radius:12px; font-weight:700; outline:none;
      transition: transform .08s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow: inset 0 0 0 1px #ffffff0e, 0 6px 18px #00000040;
    }
    button.primary{ background:linear-gradient(180deg,#6aa4ff,#4f8cff); border-color:#6aa4ff66; color:#081020;}
    button.ghost{ background:#0c1730; }
    button:active{ transform:translateY(1px) scale(0.99); }
    button:hover{ box-shadow: inset 0 0 0 1px #ffffff22, 0 12px 24px #00000055; border-color:#89b6ff77; }
    label{ font-size:12px; color:var(--mut) }
    table{ width:100%; border-collapse: collapse; font-size:14px}
    th,td{ padding:8px; border-bottom:1px solid var(--b)}
    th{ color:var(--mut); text-align:left}
    .snackbar{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#101828; border:1px solid var(--b); color:#fff; padding:10px 16px; border-radius:12px;
      opacity:0; transition: opacity .25s ease; }
    .snackbar.show{ opacity:1 }
    .danger{ color:#ffb3b3; font-weight:700 }
    .right{ margin-left:auto }
    .stack{ display:flex; flex-direction:column; gap:4px }
    .small{ font-size:12px; color:var(--mut) }
    .range{ display:flex; gap:10px; align-items:center }
    .range input{ width:180px }
  </style>
</head>
<body>
<header>
  <h1>üì∑ Esc√°ner Web Pro <span id="count" class="pill">0</span></h1>
</header>

<main>
  <div class="card stack">
    <div class="row">
      <select id="camera"></select>
      <button id="start" class="primary">Iniciar</button>
      <button id="stop" class="ghost">Detener</button>
      <button id="switch" class="ghost">Cambiar c√°mara</button>
      <button id="torch" class="ghost">Flash üî¶</button>
      <div class="range">
        <label for="zoom">Zoom</label>
        <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" />
      </div>
      <div class="range">
        <label for="dup">Antirr√°faga (ms)</label>
        <input id="dup" type="range" min="0" max="2000" step="100" value="900" />
      </div>
      <button id="export" class="right">Exportar CSV</button>
    </div>
    <div class="row">
      <input id="manual" type="text" placeholder="Introducir c√≥digo manual‚Ä¶" />
      <button id="addManual">A√±adir</button>
      <input id="file" type="file" accept="image/*" />
      <button id="copy">Copiar lista</button>
      <button id="clearLast">Borrar √∫ltimo</button>
      <button id="clearAll" class="danger">Borrar todo</button>
    </div>
    <div id="diag" class="small"></div>
  </div>

  <div class="card overlay">
    <video id="video" autoplay muted playsinline></video>
  </div>

  <div class="card">
    <strong>√öltimos 10</strong>
    <table>
      <thead><tr><th>C√≥digo</th><th>Fecha</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<footer>
  Si la c√°mara no inicia: usa HTTPS, otorga permiso, cierra apps que la usen, y prueba Chrome/Android. En iOS/Safari algunas funciones (flash/zoom) pueden no estar disponibles.
</footer>

<div id="snack" class="snackbar" role="status" aria-live="polite"></div>

<script type="module">
  import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm5/index.js";

  const reader = new BrowserMultiFormatReader();
  const video = document.getElementById('video');
  const cameraSel = document.getElementById('camera');
  const btnStart = document.getElementById('start');
  const btnStop = document.getElementById('stop');
  const btnSwitch = document.getElementById('switch');
  const btnTorch = document.getElementById('torch');
  const rangeZoom = document.getElementById('zoom');
  const rangeDup = document.getElementById('dup');
  const btnExport = document.getElementById('export');
  const btnCopy = document.getElementById('copy');
  const btnClear = document.getElementById('clearAll');
  const btnClearLast = document.getElementById('clearLast');
  const inpManual = document.getElementById('manual');
  const btnAddManual = document.getElementById('addManual');
  const fileInput = document.getElementById('file');
  const tbody = document.getElementById('tbody');
  const countEl = document.getElementById('count');
  const snack = document.getElementById('snack');
  const diag = document.getElementById('diag');

  const STORAGE_KEY = 'web_scans_pro_v1';
  let lastCode = null, lastHit = 0, controls = null, currentDeviceId = null;

  // Anim feedback
  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'square'; o.frequency.value = 880;
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15);
      o.connect(g).connect(ctx.destination); o.start();
      setTimeout(()=>{o.stop(); ctx.close();}, 180);
    }catch{}
    if (navigator.vibrate) navigator.vibrate(60);
  }
  function snackMsg(msg){ snack.textContent = msg; snack.classList.add('show'); setTimeout(()=> snack.classList.remove('show'), 900); }

  function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }
  function save(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); render(); }
  function add(code){ const d = load(); d.unshift({code, date: new Date().toISOString()}); save(d); beep(); snackMsg('Guardado: '+code); }
  function render(){ const d = load(); countEl.textContent = d.length; tbody.innerHTML = d.slice(0,10).map(r=>`<tr><td>${escapeHtml(r.code)}</td><td>${r.date}</td></tr>`).join(''); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#039;' }[c])); }

  function diagInfo(msg=''){
    const https = location.protocol === 'https:' || location.hostname === 'localhost';
    const cam = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    const text = `HTTPS:${https?'‚úÖ':'‚ùå'} ¬∑ getUserMedia:${cam?'‚úÖ':'‚ùå'} ${msg}`;
    diag.textContent = text;
  }

  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    cameraSel.innerHTML = cams.map((c,i)=>`<option value="${c.deviceId}">${c.label || 'C√°mara '+(i+1)}</option>`).join('');
    // intentar seleccionar la trasera por nombre
    const back = cams.find(c=>/back|rear|environment|trase|arri√®re/i.test(c.label));
    if(back) cameraSel.value = back.deviceId;
    currentDeviceId = cameraSel.value || (cams[0] && cams[0].deviceId) || null;
  }

  async function setupTrackFeatures(track){
    try{
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      // Torch
      if('torch' in caps){ btnTorch.disabled = false; } else { btnTorch.disabled = true; }
      // Zoom
      if('zoom' in caps){
        rangeZoom.min = caps.zoom.min || 1;
        rangeZoom.max = caps.zoom.max || 1;
        rangeZoom.step = caps.zoom.step || 0.1;
        const s = track.getSettings ? track.getSettings() : {};
        rangeZoom.value = s.zoom || rangeZoom.min;
        rangeZoom.disabled = false;
      } else {
        rangeZoom.disabled = true;
      }
    }catch(e){ rangeZoom.disabled = true; btnTorch.disabled = true; }
  }

  async function start(){
    diagInfo('¬∑ iniciando...');
    try{
      // pedir permiso primero para obtener labels
      await navigator.mediaDevices.getUserMedia({video:true});
      await listCameras();
      const deviceId = cameraSel.value || currentDeviceId || undefined;
      controls = await reader.decodeFromVideoDevice(deviceId, video, (result, err)=>{
        if(result){
          const code = result.getText?.() || result.text || '';
          const now = Date.now();
          const dupMs = Number(rangeDup.value);
          if(code && !(code===lastCode && (now-lastHit)<dupMs)){
            lastCode = code; lastHit = now; add(code);
          }
        }
      });
      currentDeviceId = deviceId;
      // configurar capacidades (torch/zoom)
      const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
      if(track) await setupTrackFeatures(track);
      diagInfo('¬∑ c√°mara lista');
    }catch(e){
      console.error(e);
      diagInfo('¬∑ error al iniciar c√°mara');
      snackMsg('No se pudo iniciar la c√°mara. Revisa permisos/HTTPS.');
    }
  }

  function stop(){
    try { controls?.stop(); } catch{}
    const stream = video.srcObject;
    if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
    diagInfo('¬∑ detenida');
  }

  async function toggleTorch(on){
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track || !track.applyConstraints) return;
    try{
      await track.applyConstraints({ advanced: [{ torch: on }] });
      snackMsg(on?'Flash ON':'Flash OFF');
    }catch(e){ snackMsg('Flash no soportado'); }
  }

  async function setZoom(v){
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track || !track.applyConstraints) return;
    try{ await track.applyConstraints({ advanced: [{ zoom: Number(v) }] }); }catch{}
  }

  async function switchCamera(){
    const options = Array.from(cameraSel.options).map(o=>o.value);
    if(!options.length) return;
    const idx = options.indexOf(currentDeviceId);
    const next = options[(idx + 1) % options.length];
    cameraSel.value = next;
    stop(); start();
  }

  function exportCsv(){
    const d = load();
    const header = 'codigo,fecha\n';
    const body = d.map(r=>`"${r.code.replace(/"/g,'""')}","${r.date}"`).join('\n') + '\n';
    const blob = new Blob([header+body], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='escaneos.csv'; a.click(); URL.revokeObjectURL(url);
  }

  async function copyList(){
    const d = load();
    const text = d.map(r=>`${r.code}\t${r.date}`).join('\n');
    try{ await navigator.clipboard.writeText(text); snackMsg('Copiado al portapapeles'); }catch{ snackMsg('No se pudo copiar'); }
  }

  function clearAll(){ if(confirm('¬øBorrar todos los registros?')) save([]); }
  function clearLast(){ const d = load(); d.shift(); save(d); }
  function addManual(){ const v = (inpManual.value||'').trim(); if(!v) return; add(v); inpManual.value=''; inpManual.focus(); }

  // Fallback: decodificar imagen
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    try{
      const res = await reader.decodeFromImageUrl(url);
      const code = res?.getText?.() || res?.text || '';
      if(code) add(code); else snackMsg('No se detect√≥ c√≥digo');
    }catch{ snackMsg('No se detect√≥ c√≥digo'); }
    finally{ URL.revokeObjectURL(url); fileInput.value=''; }
  });

  // Eventos
  btnStart.addEventListener('click', start);
  btnStop.addEventListener('click', stop);
  btnSwitch.addEventListener('click', switchCamera);
  btnTorch.addEventListener('click', async ()=>{
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    const s = track?.getSettings ? track.getSettings() : {};
    const on = !s.torch; await toggleTorch(on);
  });
  rangeZoom.addEventListener('input', (e)=> setZoom(e.target.value));
  rangeDup.addEventListener('change', ()=> snackMsg(`Antirr√°faga: ${rangeDup.value} ms`));
  btnExport.addEventListener('click', exportCsv);
  btnCopy.addEventListener('click', copyList);
  btnClear.addEventListener('click', clearAll);
  btnClearLast.addEventListener('click', clearLast);
  btnAddManual.addEventListener('click', addManual);
  inpManual.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addManual(); });

  // Inicial
  render();
  diagInfo();
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escáner Web (fix)</title>
  <style>
    :root { --bg:#0b1320; --fg:#eaeefb; --acc:#4f8cff; --mut:#9fb0d0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; background: var(--bg); color: var(--fg);
           display:grid; grid-template-rows:auto 1fr auto; min-height:100dvh; }
    header, footer { padding: 12px 16px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.08); }
    footer { border-top: 1px solid rgba(255,255,255,0.08); border-bottom:none; font-size:12px; color:var(--mut); }
    h1 { font-size:18px; margin:0; display:flex; align-items:center; gap:10px; }
    main { padding: 12px; display:grid; gap:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button, select, input[type=file] { border:1px solid rgba(255,255,255,0.15); background:#111a2e; color:var(--fg); padding:10px 14px; border-radius:10px; font-weight:600; }
    button.primary { background:var(--acc); color:#081020; border-color:transparent; }
    video { width:100%; max-height:62dvh; background:#000; border-radius:12px; }
    .pill { background:#0b172f; border:1px dashed rgba(255,255,255,0.2); padding:6px 10px; border-radius:999px; color:var(--mut); font-weight:600;}
    .snackbar { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: #101828; color: #fff; padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,.1); opacity: 0; transition: opacity .25s ease; }
    .snackbar.show { opacity: 1; }
    .error { color:#ffb3b3; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <h1>📷 Escáner Web <span class="pill" id="count">0</span></h1>
  </header>

  <main>
    <div class="row">
      <select id="cameraSelect" aria-label="Seleccionar cámara"></select>
      <button id="btnStart" class="primary">Iniciar cámara</button>
      <button id="btnStop">Detener</button>
      <button id="btnExport">Exportar CSV</button>
      <input type="file" id="fileInput" accept="image/*" />
      <button id="btnClear">Borrar todo</button>
    </div>

    <video id="video" autoplay muted playsinline></video>
    <div id="err" class="error"></div>

    <div>
      <strong>Últimos 10</strong>
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead><tr><th style="text-align:left;">Código</th><th style="text-align:left;">Fecha</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <footer>
    Requisitos: HTTPS, dar permiso de cámara, y que el navegador soporte MediaDevices. Chrome/Android es el más estable.
  </footer>

  <div id="snack" class="snackbar" role="status" aria-live="polite"></div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm5/index.js";

    const reader = new BrowserMultiFormatReader();
    const video = document.getElementById('video');
    const cameraSelect = document.getElementById('cameraSelect');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnExport = document.getElementById('btnExport');
    const btnClear = document.getElementById('btnClear');
    const fileInput = document.getElementById('fileInput');
    const tbody = document.getElementById('tbody');
    const snack = document.getElementById('snack');
    const errEl = document.getElementById('err');
    const countEl = document.getElementById('count');

    const STORAGE_KEY = 'web_scans_v2';
    let lastCode = null, lastHit = 0;
    let controls = null; // para detener decodeFromVideoDevice

    function showSnack(msg){ snack.textContent = msg; snack.classList.add('show'); setTimeout(()=>snack.classList.remove('show'), 1100); }
    function setErr(msg){ errEl.textContent = msg || ''; }

    function loadData(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return [];} }
    function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); render(); }
    function addScan(code){ const d = loadData(); d.unshift({code, date:new Date().toISOString()}); saveData(d); showSnack('Guardado: '+code); }
    function render(){
      const d = loadData();
      countEl.textContent = d.length;
      tbody.innerHTML = d.slice(0,10).map(r=>`<tr><td>${escapeHtml(r.code)}</td><td>${r.date}</td></tr>`).join('');
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }

    async function listCameras(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = cams.map((c,i)=>`<option value="${c.deviceId}">${c.label || 'Cámara '+(i+1)}</option>`).join('');
    }

    async function start(){
      setErr('');
      try {
        // algunos navegadores no dan labels si no hay permiso previo
        await navigator.mediaDevices.getUserMedia({ video: true });
        await listCameras();

        const deviceId = cameraSelect.value || (await getBackCameraId());
        controls = await reader.decodeFromVideoDevice(deviceId || undefined, video, (result, err) => {
          if (result) {
            const code = result.getText?.() || result.text || '';
            const now = Date.now();
            if(code && !(code===lastCode && (now-lastHit)<900)){
              lastCode = code; lastHit = now; addScan(code);
            }
          }
          // ignorar errores NotFoundException entre frames
        });
      } catch (e) {
        console.error(e);
        setErr('No se pudo iniciar la cámara. Verifica permisos, HTTPS y que el navegador la soporte.');
      }
    }

    function stop(){
      setErr('');
      try { controls?.stop(); } catch {}
      // detener tracks por si quedó algo activo
      const stream = video.srcObject;
      if (stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
      video.srcObject = null;
    }

    async function getBackCameraId(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      // Heurística: buscar "back" o "trasera"
      const back = cams.find(c=>/back|rear|trase|environment/i.test(c.label));
      return (back || cams[0])?.deviceId;
    }

    function exportCsv(){
      const d = loadData();
      const header = 'codigo,fecha\n';
      const body = d.map(r=>`"${r.code.replace(/"/g,'""')}","${r.date}"`).join('\n') + '\n';
      const blob = new Blob([header+body], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='escaneos.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function clearAll(){ if(confirm('¿Borrar todos los registros?')) saveData([]); }

    // Fallback: subir una foto con el código para decodificar offline
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      try {
        const result = await reader.decodeFromImageUrl(url);
        const code = result?.getText?.() || result?.text || '';
        if(code) addScan(code); else setErr('No se detectó código en la imagen.');
      } catch { setErr('No se detectó código en la imagen.'); }
      finally { URL.revokeObjectURL(url); fileInput.value=''; }
    });

    document.getElementById('btnStart').addEventListener('click', start);
    document.getElementById('btnStop').addEventListener('click', stop);
    document.getElementById('btnExport').addEventListener('click', exportCsv);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    cameraSelect.addEventListener('change', ()=>{ stop(); start(); });

    // Inicializa tabla con datos almacenados
    render();
  </script>
</body>
</html>

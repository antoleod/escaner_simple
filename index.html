<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EscÃ¡ner Web Pro (PWA v2)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1320">
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Scanner Pro">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root { --bg:#0b1320; --fg:#eaeefb; --mut:#9fb0d0; --acc:#6fa8ff; --acc2:#00e0ff; --card:#0f1a33; --b:#ffffff17; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      background: radial-gradient(1000px 800px at 100% -10%, #12264b 0%, #0b1320 45%, #0b1320 100%);
      color:var(--fg); min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto;
    }
    header, footer{padding:12px 16px; background:linear-gradient(180deg, #0f1a33aa, #0f1a3300);
      border-bottom:1px solid var(--b); backdrop-filter: saturate(120%) blur(8px);}
    footer{border-top:1px solid var(--b); color:var(--mut); font-size:12px;}
    h1{margin:0; font-size:20px; display:flex; gap:10px; align-items:center;}
    .pill{background:#0b172f; border:1px solid var(--b); padding:6px 10px; border-radius:999px; color:var(--mut); font-weight:700;}
    main{padding:12px; display:grid; gap:12px; max-width:1200px; width:100%; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--b); border-radius:18px; padding:12px; box-shadow: 0 10px 30px #00000055;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    video{width:100%; max-height:62dvh; display:block; background:#000; border-radius:16px;}
    /* Buttons iOS-like + ripple */
    button, select, input[type="text"], input[type="range"], input[type="file"]{
      border:1px solid var(--b); background:#0c1730; color:var(--fg);
      padding:10px 14px; border-radius:14px; font-weight:700; outline:none;
      transition: transform .06s ease, border-color .2s ease, box-shadow .25s ease;
      box-shadow: inset 0 0 0 1px #ffffff0e, 0 6px 18px #00000040; position:relative; overflow:hidden;
    }
    button.primary{ background:linear-gradient(180deg,#6aa4ff,#4f8cff); border-color:#6aa4ff77; color:#081020;}
    button:hover{ box-shadow: inset 0 0 0 1px #ffffff22, 0 14px 30px #00000066; border-color:#89b6ff99; transform: translateY(-1px); }
    button:active{ transform: translateY(0) scale(0.985); }
    button .rip{ position:absolute; border-radius:50%; transform:translate(-50%,-50%); pointer-events:none;
      animation:rip .7s ease-out; background: radial-gradient(circle, #ffffff66 0%, #ffffff22 40%, transparent 70%); }
    @keyframes rip{ from{width:0; height:0; opacity:1} to{width:280px; height:280px; opacity:0} }
    .snackbar{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#101828; border:1px solid var(--b); color:#fff; padding:10px 16px; border-radius:12px;
      opacity:0; transition: opacity .25s ease; }
    .snackbar.show{ opacity:1 }
    .danger{ color:#ffb3b3; font-weight:700 }
    .small{ font-size:12px; color:var(--mut) }
    .thumb{ max-height:120px; border-radius:12px; border:1px solid var(--b); }
    .error{ color:#ffb3b3; font-weight:700 }
  </style>
</head>
<body>
<header>
  <h1>ðŸ“· EscÃ¡ner Web Pro (PWA v2) <span id="count" class="pill">0</span></h1>
</header>

<main>
  <div class="card">
    <div class="row">
      <select id="camera" aria-label="CÃ¡mara"></select>
      <button id="start" class="primary">Iniciar</button>
      <button id="stop">Detener</button>
      <button id="switch">Cambiar</button>
      <button id="torch">Flash ðŸ”¦</button>
      <label class="small">Zoom <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" /></label>
      <label class="small">AntirrÃ¡faga <input id="dup" type="range" min="0" max="2000" step="100" value="900" /> ms</label>
      <button id="export" class="right">Exportar CSV</button>
      <button id="install" title="Instalar app">Instalar</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="manual" type="text" placeholder="Introducir cÃ³digo manualâ€¦" />
      <button id="addManual">AÃ±adir</button>
      <input id="file" type="file" accept="image/*" capture="environment" />
      <span id="fileName" class="small"></span>
      <button id="copy">Copiar lista</button>
      <button id="clearLast">Borrar Ãºltimo</button>
      <button id="clearAll" class="danger">Borrar todo</button>
      <button id="repair" title="Forzar permisos y refrescar">Reparar</button>
    </div>
    <div id="diag" class="small"></div>
  </div>

  <div class="card">
    <video id="video" autoplay muted playsinline></video>
    <div id="error" class="error"></div>
  </div>

  <div class="card">
    <strong>Ãšltimos 10</strong>
    <table style="width:100%; border-collapse:collapse; font-size:14px;">
      <thead><tr><th style="text-align:left;">CÃ³digo</th><th style="text-align:left;">Fecha</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <img id="preview" class="thumb" alt="Vista previa" />
      <span id="imgResult" class="small"></span>
    </div>
  </div>
</main>

<footer>
  Si la cÃ¡mara no inicia: abre la app en HTTPS, otorga permisos de CÃ¡mara al sitio, cierra apps que la usen y prueba Chrome/Android. En iOS/Safari algunas funciones (flash/zoom) pueden no estar disponibles.
</footer>

<div id="snack" class="snackbar" role="status" aria-live="polite"></div>

<script type="module">
  import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm5/index.js";

  // SW register
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }

  // Ripple
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const r = document.createElement('span'); r.className='rip';
    r.style.left = (e.offsetX || b.clientWidth/2)+'px';
    r.style.top = (e.offsetY || b.clientHeight/2)+'px';
    b.appendChild(r); setTimeout(()=> r.remove(), 700);
  });

  // Elements
  const reader = new BrowserMultiFormatReader();
  const video = document.getElementById('video');
  const cameraSel = document.getElementById('camera');
  const btnStart = document.getElementById('start');
  const btnStop = document.getElementById('stop');
  const btnSwitch = document.getElementById('switch');
  const btnTorch = document.getElementById('torch');
  const rangeZoom = document.getElementById('zoom');
  const rangeDup = document.getElementById('dup');
  const btnExport = document.getElementById('export');
  const btnCopy = document.getElementById('copy');
  const btnClear = document.getElementById('clearAll');
  const btnClearLast = document.getElementById('clearLast');
  const inpManual = document.getElementById('manual');
  const btnAddManual = document.getElementById('addManual');
  const fileInput = document.getElementById('file');
  const fileName = document.getElementById('fileName');
  const preview = document.getElementById('preview');
  const imgResult = document.getElementById('imgResult');
  const tbody = document.getElementById('tbody');
  const countEl = document.getElementById('count');
  const snack = document.getElementById('snack');
  const diag = document.getElementById('diag');
  const errEl = document.getElementById('error');

  const STORAGE_KEY = 'web_scans_pwa_v2';
  let lastCode = null, lastHit = 0, controls = null, currentDeviceId = null;

  function snackMsg(m){ snack.textContent=m; snack.classList.add('show'); setTimeout(()=>snack.classList.remove('show'), 900); }
  function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='triangle'; o.frequency.value=920; g.gain.value=0.0001; o.connect(g).connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18); setTimeout(()=>{o.stop(); ctx.close();}, 200);}catch{} if(navigator.vibrate) navigator.vibrate(60); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch{ return []; } }
  function save(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); render(); }
  function add(code){ const d=load(); d.unshift({code, date:new Date().toISOString()}); save(d); beep(); snackMsg('Guardado: '+code); }
  function render(){ const d=load(); countEl.textContent = d.length; tbody.innerHTML = d.slice(0,10).map(r=>`<tr><td>${escapeHtml(r.code)}</td><td>${r.date}</td></tr>`).join(''); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#039;' }[c])); }
  function diagInfo(msg=''){ const https = location.protocol === 'https:' || location.hostname === 'localhost'; const cam = !!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia); diag.textContent = `HTTPS:${https?'âœ…':'âŒ'} Â· getUserMedia:${cam?'âœ…':'âŒ'} ${msg}`; }
  function setError(m=''){ errEl.textContent = m; }

  // Permission + camera
  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    cameraSel.innerHTML = cams.map((c,i)=>`<option value="${c.deviceId}">${c.label || 'CÃ¡mara '+(i+1)}</option>`).join('');
    const back = cams.find(c=>/back|rear|environment|trase|arriÃ¨re/i.test(c.label));
    if(back) cameraSel.value = back.deviceId;
    currentDeviceId = cameraSel.value || (cams[0] && cams[0].deviceId) || null;
  }

  async function setupTrackFeatures(track){
    try{
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      btnTorch.disabled = !('torch' in caps);
      if('zoom' in caps){
        rangeZoom.min = caps.zoom.min || 1;
        rangeZoom.max = caps.zoom.max || 1;
        rangeZoom.step = caps.zoom.step || 0.1;
        const s = track.getSettings ? track.getSettings() : {};
        rangeZoom.value = s.zoom || rangeZoom.min; rangeZoom.disabled = false;
      } else { rangeZoom.disabled = true; }
    }catch{ rangeZoom.disabled = true; btnTorch.disabled = true; }
  }

  async function forcePermissionPrompt(){
    // Llamada mÃ­nima para forzar diÃ¡logo de permisos
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      stream.getTracks().forEach(t=>t.stop());
      snackMsg('Permiso de cÃ¡mara verificado.');
    }catch(e){
      setError('CÃ¡mara bloqueada: abre ajustes del sitio y permite el acceso.');
      snackMsg('Permiso denegado/bloqueado');
    }
  }

  async function start(){
    setError(''); diagInfo('Â· iniciando...');
    try{
      // fuerza permisos primero
      await forcePermissionPrompt();
      await listCameras();
      const deviceId = cameraSel.value || currentDeviceId || undefined;
      controls = await reader.decodeFromVideoDevice(deviceId, video, (result, err)=>{
        if(result){
          const code = result.getText?.() || result.text || '';
          const now = Date.now();
          const dupMs = Number(rangeDup.value);
          if(code && !(code===lastCode && (now-lastHit)<dupMs)){
            lastCode = code; lastHit = now; add(code);
          }
        }
      });
      currentDeviceId = deviceId;
      const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
      if(track) await setupTrackFeatures(track);
      diagInfo('Â· cÃ¡mara lista');
    }catch(e){
      console.error(e);
      setError('No se pudo iniciar la cÃ¡mara. Verifica permisos del navegador (CÃ¡mara: Permitido) y HTTPS.');
      snackMsg('No se pudo iniciar la cÃ¡mara');
    }
  }

  function stop(){
    try { controls?.stop(); } catch{}
    const stream = video.srcObject;
    if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
    video.srcObject = null; diagInfo('Â· detenida');
  }

  async function toggleTorch(on){
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track || !track.applyConstraints) return snackMsg('Flash no soportado');
    try{ await track.applyConstraints({ advanced: [{ torch: on }] }); snackMsg(on?'Flash ON':'Flash OFF'); }catch{ snackMsg('Flash no soportado'); }
  }
  async function setZoom(v){
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track || !track.applyConstraints) return;
    try{ await track.applyConstraints({ advanced: [{ zoom: Number(v) }] }); }catch{}
  }
  async function switchCamera(){
    const options = Array.from(cameraSel.options).map(o=>o.value);
    if(!options.length) return;
    const idx = options.indexOf(currentDeviceId);
    const next = options[(idx+1)%options.length];
    cameraSel.value = next; stop(); start();
  }

  function exportCsv(){
    const d = load();
    const header = 'codigo,fecha\\n';
    const body = d.map(r=>`"${r.code.replace(/"/g,'""')}","${r.date}"`).join('\\n')+'\\n';
    const blob = new Blob([header+body], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='escaneos.csv'; a.click(); URL.revokeObjectURL(url);
  }
  async function copyList(){
    const d=load(); const text = d.map(r=>`${r.code}\\t${r.date}`).join('\\n');
    try{ await navigator.clipboard.writeText(text); snackMsg('Copiado'); }catch{ snackMsg('No se pudo copiar'); }
  }
  function clearAll(){ if(confirm('Â¿Borrar todo?')) save([]); }
  function clearLast(){ const d=load(); d.shift(); save(d); }
  function addManual(){ const v=(document.getElementById('manual').value||'').trim(); if(!v) return; add(v); document.getElementById('manual').value=''; }

  // Fallback imagen + preview
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    fileName.textContent = f.name;
    const url = URL.createObjectURL(f);
    preview.src = url;
    try{
      const res = await reader.decodeFromImageUrl(url);
      const code = res?.getText?.() || res?.text || '';
      if(code){ add(code); imgResult.textContent='LeÃ­do: '+code; }
      else { imgResult.textContent='No se detectÃ³ cÃ³digo en la imagen.'; }
    }catch{ imgResult.textContent='No se detectÃ³ cÃ³digo en la imagen.'; }
    finally{ URL.revokeObjectURL(url); fileInput.value=''; }
  });

  // Repair tools
  async function repair(){
    // Limpia cachÃ©s y SW, y fuerza prompt
    try{
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      localStorage.removeItem(STORAGE_KEY);
      await forcePermissionPrompt();
      location.reload();
    }catch(e){ snackMsg('No se pudo reparar automÃ¡ticamente'); }
  }

  // Events
  btnStart.addEventListener('click', start);
  btnStop.addEventListener('click', stop);
  btnSwitch.addEventListener('click', switchCamera);
  btnTorch.addEventListener('click', async ()=>{
    const track = video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    const s = track?.getSettings ? track.getSettings() : {};
    const on = !s.torch; await toggleTorch(on);
  });
  rangeZoom.addEventListener('input', e=> setZoom(e.target.value));
  rangeDup.addEventListener('change', ()=> snackMsg(`AntirrÃ¡faga: ${rangeDup.value} ms`));
  document.getElementById('export').addEventListener('click', exportCsv);
  btnCopy.addEventListener('click', copyList);
  btnClear.addEventListener('click', clearAll);
  btnClearLast.addEventListener('click', clearLast);
  btnAddManual.addEventListener('click', addManual);
  document.getElementById('repair').addEventListener('click', repair);
  document.addEventListener('touchstart', ()=> { /* primer toque: intenta permisos */
    forcePermissionPrompt();
  }, { once:true, passive:true });

  // Init
  render();
  diagInfo();
</script>
</body>
</html>
